#!/bin/bash
# Usage: docs [path]
# Serves a folder of markdown files as a clean docs site using Docsify.
# If no path given, serves the current directory.

dir="${1:-.}"
dir="$(cd "$dir" && pwd)"

# Create minimal docsify index if not present
if [ ! -f "$dir/index.html" ]; then
  # Find the first markdown file to use as homepage
  homepage=$(find "$dir" -maxdepth 2 -name '*.md' -not -name '_*' -not -path '*/node_modules/*' -not -path '*/.git/*' | sort | head -1)
  if [ -n "$homepage" ]; then
    homepage_rel="${homepage#$dir/}"
  fi

  cat > "$dir/index.html" << EOF
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsify-themeable@0/dist/css/theme-simple-dark.min.css">
  <style>
    :root {
      --base-font-size: 15px;
      --theme-color: #58a6ff;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <script>
    window.\$docsify = {
      auto2top: true,
      loadSidebar: '_sidebar.md',
      subMaxLevel: 3,
      search: { placeholder: 'Search...', noData: 'No results', depth: 3 },
      homepage: '${homepage_rel:-README.md}',
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/docsify@4/lib/docsify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docsify@4/lib/plugins/search.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-typescript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-bash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-json.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-tsx.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-yaml.min.js"></script>
</body>
</html>
EOF
  echo "Created index.html in $dir"
fi

# Generate sidebar from markdown files if not present
if [ ! -f "$dir/_sidebar.md" ]; then
  echo "<!-- Auto-generated sidebar -->" > "$dir/_sidebar.md"
  find "$dir" -name '*.md' -not -name '_*' -not -path '*/node_modules/*' -not -path '*/.git/*' | sort | while read -r f; do
    rel="${f#$dir/}"
    # Extract first heading, skipping YAML frontmatter
    name=$(awk '/^---$/ && NR==1 {fm=1; next} fm && /^---$/ {fm=0; next} !fm && /^#/ {sub(/^#+ */, ""); print; exit}' "$f")
    [ -z "$name" ] && name="$rel"
    echo "- [$name]($rel)" >> "$dir/_sidebar.md"
  done
  echo "Created _sidebar.md in $dir"
fi

echo "Serving docs from $dir"
echo "Open http://localhost:3131"
npx docsify-cli serve "$dir" --port 3131
